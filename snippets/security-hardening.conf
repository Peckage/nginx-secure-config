# Advanced Security Hardening
# Additional security measures to prevent attacks

# Disable any unwanted HTTP methods
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS|PATCH)$ ) {
    return 405;
}

# Block common exploit attempts
location ~* (\.php|\.aspx|\.asp|\.cgi|\.pl)$ {
    # Only allow if this is explicitly a PHP site
    # Otherwise, these should be blocked in templates
}

# Protect against BREACH attack
gzip_vary on;

# Prevent buffer overflow attacks
client_body_buffer_size 1k;
client_header_buffer_size 1k;
client_max_body_size 1k;
large_client_header_buffers 2 1k;

# Limit request size to prevent DoS
client_body_in_single_buffer on;

# Prevent version disclosure in error pages
fastcgi_hide_header X-Powered-By;
fastcgi_hide_header X-Runtime;

# Additional timeout protections against slowloris
reset_timedout_connection on;

# Only allow specific user agents (optional - uncomment and customize)
# Block bad bots
if ($http_user_agent ~* (HTTrack|harvest|audit|dirbuster|nikto|acunetix|sqlmap|metasploit|nmap|masscan|openvas|w3af|skipfish|havij|bsqlbf) ) {
    return 403;
}

# Block SQL injection attempts in URLs
if ($query_string ~* ([;']|(--)|union|select|insert|drop|update|delete|replace|truncate)) {
    return 403;
}

# Block XSS attempts in URLs
if ($query_string ~* (<|>|%3C|%3E|javascript|eval|alert)) {
    return 403;
}

# Block path traversal attempts
if ($query_string ~* (\.\./|\.\.\\|/etc/passwd|/etc/shadow)) {
    return 403;
}

# Block remote code execution attempts
if ($query_string ~* (base64_encode|base64_decode|eval|exec|system|passthru|shell_exec)) {
    return 403;
}

# Prevent clickjacking at location level
add_header X-Frame-Options "DENY" always;

# Additional mime type restrictions
location ~ /\.(ht|git|svn|hg|env|ini|conf|log|bak|old|sql|sh|bash) {
    deny all;
    return 404;
}
